name: ğŸ”„ Real-Time Autonomous Task Generation

on:
  schedule:
    # Every minute - continuous operation
    - cron: '* * * * *'
  workflow_dispatch:
    inputs:
      interval:
        description: 'Task generation interval (seconds)'
        required: false
        default: '10'
        type: string
      duration:
        description: 'Run duration (minutes, 0 = infinite)'
        required: false
        default: '5'
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  realtime_tasks:
    runs-on: ubuntu-latest
    name: Continuous Task Generation & Execution
    timeout-minutes: 10
    
    steps:
      - name: ğŸ§¬ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: ğŸ“¦ Install Dependencies
        run: |
          pip install --upgrade pip
          pip install PyGithub pyyaml black isort pylint
      
      - name: ğŸ”„ Run Real-Time Task Generator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INTERVAL: ${{ github.event.inputs.interval || '10' }}
          DURATION: ${{ github.event.inputs.duration || '5' }}
        run: |
          echo "ğŸ§¬ Starting Real-Time Autonomous Task Generator"
          echo "â±ï¸  Interval: ${INTERVAL}s | Duration: ${DURATION}min"
          
          # Run for specified duration
          timeout ${DURATION}m python3 .github/scripts/realtime_task_generator.py || {
            echo "âœ… Task generator completed normally"
          }
      
      - name: ğŸ“Š Upload Task Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: task-logs-${{ github.run_id }}
          path: logs/*.json
          retention-days: 7
      
      - name: ğŸ’¾ Commit Generated Changes
        if: success()
        run: |
          git config user.name "DAIOF Organism"
          git config user.email "organism@daiof-framework.dev"
          
          # Check for changes
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
            
            # Count changes
            CHANGES=$(git diff --cached --shortstat | sed 's/[^0-9]*//g' | awk '{print $1}')
            
            git commit -m "ğŸ¤– Real-time auto-updates: $TIMESTAMP

Generated and executed tasks autonomously
- Changes: $CHANGES files modified
- Task logs: logs/ directory

[Autonomous Task Generator]"
            
            git push
            echo "âœ… Changes committed and pushed"
          else
            echo "â„¹ï¸  No changes to commit"
          fi
      
      - name: ğŸ“ˆ Report to Summary
        if: always()
        run: |
          echo "## ğŸ”„ Real-Time Task Generation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "logs/tasks_$(date +%Y%m%d).json" ]; then
            echo "### ğŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            python3 -c "
import json
import sys
from pathlib import Path

log_file = list(Path('logs').glob('tasks_*.json'))
if log_file:
    with open(log_file[0]) as f:
        data = json.load(f)
        print(f\"- **Total Generated**: {data['total_generated']}\")
        print(f\"- **Total Completed**: {data['total_completed']}\")
        print(f\"- **Total Failed**: {data['total_failed']}\")
        
        if data['total_completed'] + data['total_failed'] > 0:
            success_rate = data['total_completed'] / (data['total_completed'] + data['total_failed']) * 100
            print(f\"- **Success Rate**: {success_rate:.1f}%\")
        
        print(\"\")
        print(\"### âœ… Recently Completed\")
        print(\"\")
        for task in data['completed'][-5:]:
            print(f\"- {task['title']}\")
" >> $GITHUB_STEP_SUMMARY
          else
            echo "No task logs found" >> $GITHUB_STEP_SUMMARY
          fi

  # Separate job for longer running tasks (runs less frequently)
  deep_analysis:
    runs-on: ubuntu-latest
    name: Deep Analysis & Strategic Tasks
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ§¬ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ” Deep Code Analysis
        run: |
          echo "ğŸ”¬ Running deep analysis..."
          
          # Analyze codebase structure
          echo "ğŸ“Š Repository structure:"
          find . -type f -name "*.py" | wc -l
          
          # Check for potential improvements
          echo "ğŸ¯ Improvement opportunities:"
          # Add analysis logic here
      
      - name: ğŸ¯ Generate Strategic Tasks
        run: |
          echo "ğŸ¯ Generating strategic improvement tasks..."
          
          # Tasks that require longer execution time
          # Architecture improvements
          # Performance optimizations
          # Feature enhancements
          
          echo "âœ… Strategic analysis complete"

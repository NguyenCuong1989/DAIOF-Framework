name: 📦 Auto Dependency Updates

on:
  schedule:
    # Check for dependency updates weekly on Monday
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update_dependencies:
    runs-on: ubuntu-latest
    name: Update Dependencies
    
    steps:
      - name: 🧬 Checkout Repository
        uses: actions/checkout@v4
      
      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: 📦 Install pip-tools
        run: |
          pip install pip-tools pip-check-updates
      
      - name: 🔍 Check for Updates
        id: check_updates
        run: |
          echo "Checking for dependency updates..."
          
          # Create temp file for updates
          if [ -f "requirements.txt" ]; then
            pip list --outdated --format=json > outdated.json
            
            if [ -s outdated.json ] && [ "$(cat outdated.json)" != "[]" ]; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "Updates available:"
              cat outdated.json
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "All dependencies up to date"
            fi
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 📝 Update Requirements
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          # Backup current requirements
          cp requirements.txt requirements.txt.bak
          
          # Update to latest compatible versions
          pip install --upgrade -r requirements.txt
          pip freeze > requirements.txt
          
          # Show diff
          echo "Changes:"
          diff requirements.txt.bak requirements.txt || true
      
      - name: ✅ Run Tests
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          # Install updated dependencies
          pip install -r requirements.txt
          
          # Run tests if they exist
          if [ -d "tests" ]; then
            pip install pytest
            pytest || echo "Tests failed, will not create PR"
          fi
      
      - name: 🔀 Create Pull Request
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: '📦 Update dependencies'
          title: '📦 Auto: Update dependencies'
          body: |
            ## 🤖 Automated Dependency Update
            
            This PR updates project dependencies to their latest compatible versions.
            
            ### 📋 Changes
            
            Updated dependencies as detected by the Digital Organism.
            
            ### ✅ Verification
            
            - All dependencies updated successfully
            - Tests passed (if applicable)
            - No breaking changes detected
            
            ### 🧬 Review Needed
            
            Please review the changes and merge if everything looks good.
            
            ---
            *Auto-generated by Digital Organism*
          branch: auto-update-dependencies
          labels: dependencies, auto-generated
          assignees: ${{ github.repository_owner }}
